<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain Tree Nutrition - Business Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .tab-button.active { @apply bg-blue-600 text-white; }
        .tab-button:not(.active) { @apply text-gray-600 hover:bg-gray-100; }
        .tab-content { @apply hidden; }
        .tab-content.active { @apply block; }
        .btn-primary { @apply px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center bg-gray-50">
        <div class="max-w-md w-full space-y-8">
            <div class="text-center">
                <h2 class="text-3xl font-bold text-gray-900">Brain Tree Nutrition</h2>
                <p class="mt-2 text-gray-600">Business Management Platform</p>
            </div>
            <form id="loginForm" class="mt-8 space-y-6">
                <div>
                    <input id="email" name="email" type="email" required class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Email address">
                </div>
                <div>
                    <input id="password" name="password" type="password" required class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Password">
                </div>
                <div>
                    <button type="submit" class="w-full btn-primary">Sign In</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 px-6 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-xl font-bold">Brain Tree Nutrition</h1>
                <button onclick="logout()" class="btn-primary">Logout</button>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="bg-white border-b border-gray-200 px-6 py-2">
            <div class="flex space-x-8">
                                            <button class="tab-button active" onclick="showTab('dashboard', this)">Dashboard</button>
                            <button class="tab-button" onclick="showTab('products', this)">Products</button>
                            <button class="tab-button" onclick="showTab('customers', this)">Customers</button>
                            <button class="tab-button" onclick="showTab('orders', this)">Orders</button>
                            <button class="tab-button" onclick="showTab('integrations', this)">Integrations</button>
            </div>
        </nav>

        <!-- Content -->
        <main class="p-6">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-gray-500 text-sm">Total Revenue</h3>
                        <p class="text-2xl font-bold" id="totalRevenue">$0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-gray-500 text-sm">Total Orders</h3>
                        <p class="text-2xl font-bold" id="totalOrders">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-gray-500 text-sm">Customers</h3>
                        <p class="text-2xl font-bold" id="totalCustomers">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-gray-500 text-sm">Products</h3>
                        <p class="text-2xl font-bold" id="totalProducts">0</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Recent Orders</h3>
                        <div id="recentOrders"></div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-semibold mb-4">Top Products</h3>
                        <div id="topProducts"></div>
                    </div>
                </div>
            </div>

            <!-- Products Tab -->
            <div id="products" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Products</h2>
                    <button onclick="showAddProductModal()" class="btn-primary">Add Product</button>
                </div>
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6">
                        <div id="productsList"></div>
                    </div>
                </div>
            </div>

            <!-- Customers Tab -->
            <div id="customers" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Customers</h2>
                    <button onclick="showAddCustomerModal()" class="btn-primary">Add Customer</button>
                </div>
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6">
                        <div id="customersList"></div>
                    </div>
                </div>
            </div>

            <!-- Orders Tab -->
            <div id="orders" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Orders</h2>
                    <button onclick="showAddOrderModal()" class="btn-primary">Add Order</button>
                </div>
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6">
                        <div id="ordersList"></div>
                    </div>
                </div>
            </div>

            <!-- Integrations Tab -->
            <div id="integrations" class="tab-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Integrations</h2>
                    <button onclick="showAddIntegrationModal()" class="btn-primary">Add Integration</button>
                </div>
                <div class="bg-white rounded-lg shadow">
                    <div class="p-6">
                        <div id="integrationsList"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        let authToken = localStorage.getItem('authToken');
        let currentUser = JSON.parse(localStorage.getItem('user'));

        // API Functions
        async function apiCall(endpoint, options = {}) {
            const baseUrl = window.location.origin;
            const url = `${baseUrl}/api${endpoint}`;
            
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                },
                ...options
            };

            try {
                const response = await fetch(url, config);
                if (!response.ok) {
                    if (response.status === 401) {
                        logout();
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Authentication
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const response = await apiCall('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });

                authToken = response.token;
                currentUser = response.user;
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('user', JSON.stringify(currentUser));

                showMainApp();
                loadDashboard();
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        });

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            authToken = null;
            currentUser = null;
            showLoginScreen();
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }

        // Tab Navigation
        function showTab(tabName, clickedElement) {
            try {
                console.log('Tab clicked:', tabName);
                
                // Remove active class from all tabs and content
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to selected tab and content
                const targetTab = document.getElementById(tabName);
                if (targetTab) {
                    targetTab.classList.add('active');
                    console.log('✅ Tab switched to:', tabName);
                } else {
                    console.error('❌ Tab not found:', tabName);
                    return;
                }
                
                if (clickedElement) {
                    clickedElement.classList.add('active');
                }

                // Load content based on tab
                switch(tabName) {
                    case 'dashboard':
                        loadDashboard();
                        break;
                    case 'products':
                        loadProducts();
                        break;
                    case 'customers':
                        loadCustomers();
                        break;
                    case 'orders':
                        loadOrders();
                        break;
                    case 'integrations':
                        loadIntegrations();
                        break;
                    default:
                        console.error('❌ Unknown tab:', tabName);
                }
            } catch (error) {
                console.error('❌ Error switching tabs:', error);
            }
        }

        // Dashboard
        async function loadDashboard() {
            try {
                const data = await apiCall('/dashboard');
                
                document.getElementById('totalRevenue').textContent = `$${data.stats.revenue.toLocaleString()}`;
                document.getElementById('totalOrders').textContent = data.stats.orders;
                document.getElementById('totalCustomers').textContent = data.stats.customers;
                document.getElementById('totalProducts').textContent = data.stats.products;

                // Recent Orders
                const recentOrdersHtml = data.recentOrders.map(order => `
                    <div class="border-b py-2">
                        <div class="flex justify-between">
                            <span>${order.customerId?.name || 'Unknown'}</span>
                            <span class="font-semibold">$${order.total}</span>
                        </div>
                        <div class="text-sm text-gray-500">${new Date(order.createdAt).toLocaleDateString()}</div>
                    </div>
                `).join('');
                document.getElementById('recentOrders').innerHTML = recentOrdersHtml;

                // Top Products
                const topProductsHtml = data.topProducts.map(item => `
                    <div class="border-b py-2">
                        <div class="flex justify-between">
                            <span>${item.product[0]?.name || 'Unknown'}</span>
                            <span class="font-semibold">${item.totalSold} sold</span>
                        </div>
                    </div>
                `).join('');
                document.getElementById('topProducts').innerHTML = topProductsHtml;
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Products
        async function loadProducts() {
            try {
                const products = await apiCall('/products');
                const productsHtml = products.map(product => `
                    <div class="border-b py-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-semibold">${product.name}</h3>
                                <p class="text-gray-600">${product.description}</p>
                                <p class="text-sm text-gray-500">SKU: ${product.sku}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold">$${product.price}</p>
                                <p class="text-sm text-gray-500">Stock: ${product.stock}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('productsList').innerHTML = productsHtml;
            } catch (error) {
                console.error('Error loading products:', error);
            }
        }

        // Customers
        async function loadCustomers() {
            try {
                const customers = await apiCall('/customers');
                const customersHtml = customers.map(customer => `
                    <div class="border-b py-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-semibold">${customer.name}</h3>
                                <p class="text-gray-600">${customer.email}</p>
                                <p class="text-sm text-gray-500">${customer.phone || 'No phone'}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold">$${customer.totalSpent}</p>
                                <p class="text-sm text-gray-500">${customer.orders} orders</p>
                            </div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('customersList').innerHTML = customersHtml;
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        // Orders
        async function loadOrders() {
            try {
                const orders = await apiCall('/orders');
                const ordersHtml = orders.map(order => `
                    <div class="border-b py-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-semibold">Order #${order._id.slice(-6)}</h3>
                                <p class="text-gray-600">${order.customerId?.name || 'Unknown Customer'}</p>
                                <p class="text-sm text-gray-500">${new Date(order.createdAt).toLocaleDateString()}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold">$${order.total}</p>
                                <p class="text-sm text-gray-500">${order.status}</p>
                            </div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('ordersList').innerHTML = ordersHtml;
            } catch (error) {
                console.error('Error loading orders:', error);
            }
        }

        // Integrations
        async function loadIntegrations() {
            try {
                const integrations = await apiCall('/integrations');
                const integrationsHtml = integrations.map(integration => `
                    <div class="border-b py-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="font-semibold">${integration.platform}</h3>
                                <p class="text-gray-600">${integration.storeUrl || 'No URL'}</p>
                                <p class="text-sm text-gray-500">Last sync: ${integration.lastSync ? new Date(integration.lastSync).toLocaleDateString() : 'Never'}</p>
                            </div>
                            <div class="text-right">
                                <span class="px-2 py-1 rounded text-sm ${integration.isActive ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                    ${integration.isActive ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                        </div>
                    </div>
                `).join('');
                document.getElementById('integrationsList').innerHTML = integrationsHtml;
            } catch (error) {
                console.error('Error loading integrations:', error);
            }
        }

        // Modal Functions
        function showAddProductModal() {
            const modal = `
                <div id="productModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-md">
                        <h3 class="text-lg font-semibold mb-4">Add New Product</h3>
                        <form id="addProductForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Product Name</label>
                                <input type="text" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Description</label>
                                <textarea name="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md"></textarea>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Price ($)</label>
                                    <input type="number" name="price" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Stock</label>
                                    <input type="number" name="stock" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">SKU</label>
                                <input type="text" name="sku" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Category</label>
                                <input type="text" name="category" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div class="flex gap-2 pt-4">
                                <button type="submit" class="flex-1 btn-primary">Add Product</button>
                                <button type="button" onclick="closeModal('productModal')" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modal);
            
            document.getElementById('addProductForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const productData = Object.fromEntries(formData.entries());
                productData.price = parseFloat(productData.price);
                productData.stock = parseInt(productData.stock);
                
                try {
                    await apiCall('/products', {
                        method: 'POST',
                        body: JSON.stringify(productData)
                    });
                    closeModal('productModal');
                    loadProducts();
                    alert('Product added successfully!');
                } catch (error) {
                    alert('Error adding product: ' + error.message);
                }
            });
        }

        function showAddCustomerModal() {
            const modal = `
                <div id="customerModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-md">
                        <h3 class="text-lg font-semibold mb-4">Add New Customer</h3>
                        <form id="addCustomerForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Name</label>
                                <input type="text" name="name" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" name="email" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Phone</label>
                                <input type="tel" name="phone" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div class="flex gap-2 pt-4">
                                <button type="submit" class="flex-1 btn-primary">Add Customer</button>
                                <button type="button" onclick="closeModal('customerModal')" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modal);
            
            document.getElementById('addCustomerForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const customerData = Object.fromEntries(formData.entries());
                
                try {
                    await apiCall('/customers', {
                        method: 'POST',
                        body: JSON.stringify(customerData)
                    });
                    closeModal('customerModal');
                    loadCustomers();
                    alert('Customer added successfully!');
                } catch (error) {
                    alert('Error adding customer: ' + error.message);
                }
            });
        }

        function showAddOrderModal() {
            const modal = `
                <div id="orderModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-md">
                        <h3 class="text-lg font-semibold mb-4">Add New Order</h3>
                        <form id="addOrderForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Customer Email</label>
                                <input type="email" name="customerEmail" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Total Amount ($)</label>
                                <input type="number" name="total" step="0.01" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Status</label>
                                <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="pending">Pending</option>
                                    <option value="completed">Completed</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="flex gap-2 pt-4">
                                <button type="submit" class="flex-1 btn-primary">Add Order</button>
                                <button type="button" onclick="closeModal('orderModal')" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modal);
            
            document.getElementById('addOrderForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const orderData = Object.fromEntries(formData.entries());
                orderData.total = parseFloat(orderData.total);
                
                try {
                    await apiCall('/orders', {
                        method: 'POST',
                        body: JSON.stringify(orderData)
                    });
                    closeModal('orderModal');
                    loadOrders();
                    alert('Order added successfully!');
                } catch (error) {
                    alert('Error adding order: ' + error.message);
                }
            });
        }

        function showAddIntegrationModal() {
            const modal = `
                <div id="integrationModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-md">
                        <h3 class="text-lg font-semibold mb-4">Add Integration</h3>
                        <form id="addIntegrationForm" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Platform</label>
                                <select name="platform" required class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                    <option value="">Select Platform</option>
                                    <option value="shopify">Shopify</option>
                                    <option value="stripe">Stripe</option>
                                    <option value="mailchimp">Mailchimp</option>
                                    <option value="quickbooks">QuickBooks</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">API Key</label>
                                <input type="text" name="apiKey" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Store URL</label>
                                <input type="url" name="storeUrl" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" name="isActive" id="isActive" class="mr-2">
                                <label for="isActive" class="text-sm font-medium text-gray-700">Active Integration</label>
                            </div>
                            <div class="flex gap-2 pt-4">
                                <button type="submit" class="flex-1 btn-primary">Add Integration</button>
                                <button type="button" onclick="closeModal('integrationModal')" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modal);
            
            document.getElementById('addIntegrationForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const integrationData = Object.fromEntries(formData.entries());
                integrationData.isActive = integrationData.isActive === 'on';
                
                try {
                    await apiCall('/integrations', {
                        method: 'POST',
                        body: JSON.stringify(integrationData)
                    });
                    closeModal('integrationModal');
                    loadIntegrations();
                    alert('Integration added successfully!');
                } catch (error) {
                    alert('Error adding integration: ' + error.message);
                }
            });
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }

        // Initialize
        if (authToken && currentUser) {
            showMainApp();
            loadDashboard();
        } else {
            showLoginScreen();
        }
    </script>
</body>
</html> 